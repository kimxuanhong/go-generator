package gorm

import (
	"fmt"

	"gorm.io/driver/mysql"
	"gorm.io/driver/postgres"
	"gorm.io/driver/sqlite"
	"gorm.io/gorm"
	"gorm.io/gorm/logger"
)

// Config holds generic GORM configuration that can be shared across SQL databases.
type Config struct {
	Driver                string `json:"driver" mapstructure:"driver"`                                       // postgres, mysql, sqlite
	DSN                   string `json:"dsn" mapstructure:"dsn"`
	LoggerLevel           string `json:"loggerLevel" mapstructure:"loggerLevel"`                             // silent, error, warn, info
	SkipDefaultTransaction bool   `json:"skipDefaultTransaction" mapstructure:"skipDefaultTransaction"`
	PrepareStmt           bool   `json:"prepareStmt" mapstructure:"prepareStmt"`
}

// DB wraps the underlying *gorm.DB instance.
type DB struct {
	db *gorm.DB
}

// New opens a GORM connection using the configured driver and DSN.
func New(cfg Config) (*DB, error) {
	if cfg.Driver == "" {
		return nil, fmt.Errorf("gorm driver must be provided")
	}
	if cfg.DSN == "" {
		return nil, fmt.Errorf("gorm DSN must be provided")
	}

	dialector, err := dialectorFromConfig(cfg)
	if err != nil {
		return nil, err
	}

	gormCfg := &gorm.Config{
		SkipDefaultTransaction: cfg.SkipDefaultTransaction,
		PrepareStmt:            cfg.PrepareStmt,
	}

	if cfg.LoggerLevel != "" {
		gormCfg.Logger = logger.Default.LogMode(parseLogLevel(cfg.LoggerLevel))
	}

	db, err := gorm.Open(dialector, gormCfg)
	if err != nil {
		return nil, err
	}

	return &DB{db: db}, nil
}

// Close gracefully closes the underlying database connection.
func (d *DB) Close() error {
	if d == nil || d.db == nil {
		return nil
	}
	sqlDB, err := d.db.DB()
	if err != nil {
		return err
	}
	return sqlDB.Close()
}

// GORM returns the wrapped *gorm.DB instance.
func (d *DB) GORM() *gorm.DB {
	if d == nil {
		return nil
	}
	return d.db
}

func dialectorFromConfig(cfg Config) (gorm.Dialector, error) {
	switch cfg.Driver {
	case "postgres":
		return postgres.Open(cfg.DSN), nil
	case "mysql":
		return mysql.Open(cfg.DSN), nil
	case "sqlite":
		return sqlite.Open(cfg.DSN), nil
	default:
		return nil, fmt.Errorf("unsupported gorm driver %q", cfg.Driver)
	}
}

func parseLogLevel(level string) logger.LogLevel {
	switch level {
	case "silent":
		return logger.Silent
	case "error":
		return logger.Error
	case "warn":
		return logger.Warn
	case "info":
		return logger.Info
	default:
		return logger.Warn
	}
}
