package repository

import (
	"fmt"

	"gorm.io/gorm"
	"{{.ModuleName}}/internal/domain"
	{{- if index .Includes "postgres"}}
	"{{.ModuleName}}/internal/infrastructure/postgres"
	{{- end}}
	{{- if index .Includes "mysql"}}
	"{{.ModuleName}}/internal/infrastructure/mysql"
	{{- end}}
)

// UserRepositoryImpl implements UserRepository
type UserRepositoryImpl struct {
	{{- if index .Includes "postgres"}}
	DB *postgres.DB
	{{- end}}
	{{- if index .Includes "mysql"}}
	DB *mysql.DB
	{{- end}}
}

// NewUserRepository creates a new user repository
func NewUserRepository({{- if index .Includes "postgres"}}db *postgres.DB{{- end}}{{- if and (index .Includes "postgres") (index .Includes "mysql")}}, {{- end}}{{- if index .Includes "mysql"}}db *mysql.DB{{- end}}) domain.UserRepository {
	return &UserRepositoryImpl{
		{{- if index .Includes "postgres"}}
		DB: db,
		{{- end}}
		{{- if index .Includes "mysql"}}
		DB: db,
		{{- end}}
	}
}

// getDB returns the first available database connection (prefers postgres over mysql)
func (r *UserRepositoryImpl) getDB() *gorm.DB {
	{{- if index .Includes "postgres"}}
	if r.DB != nil {
		return r.DB.GORM()
	}
	{{- end}}
	{{- if index .Includes "mysql"}}
	if r.DB != nil {
		return r.DB.GORM()
	}
	{{- end}}
	return nil
}

// GetByID retrieves a user by ID
func (r *UserRepositoryImpl) GetByID(id int64) (*domain.User, error) {
	db := r.getDB()
	if db == nil {
		return nil, fmt.Errorf("database not available")
	}
	var user domain.User
	if err := db.First(&user, id).Error; err != nil {
		return nil, fmt.Errorf("failed to get user: %w", err)
	}
	return &user, nil
}

// Create creates a new user
func (r *UserRepositoryImpl) Create(user *domain.User) error {
	db := r.getDB()
	if db == nil {
		return fmt.Errorf("database not available")
	}
	if err := db.Create(user).Error; err != nil {
		return fmt.Errorf("failed to create user: %w", err)
	}
	return nil
}

// Update updates an existing user
func (r *UserRepositoryImpl) Update(user *domain.User) error {
	db := r.getDB()
	if db == nil {
		return fmt.Errorf("database not available")
	}
	if err := db.Save(user).Error; err != nil {
		return fmt.Errorf("failed to update user: %w", err)
	}
	return nil
}

// Delete deletes a user by ID
func (r *UserRepositoryImpl) Delete(id int64) error {
	db := r.getDB()
	if db == nil {
		return fmt.Errorf("database not available")
	}
	if err := db.Delete(&domain.User{}, id).Error; err != nil {
		return fmt.Errorf("failed to delete user: %w", err)
	}
	return nil
}

