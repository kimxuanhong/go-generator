package jobs

import (
	"context"
	"log"
	"time"

	{{- if index .Includes "redis"}}
	"{{.ModuleName}}/internal/infrastructure/redis"
	{{- end}}
	{{- if index .Includes "postgres"}}
	"{{.ModuleName}}/internal/infrastructure/postgres"
	{{- end}}
	{{- if index .Includes "mysql"}}
	"{{.ModuleName}}/internal/infrastructure/mysql"
	{{- end}}
)

// ExampleJob represents an example cron job
type ExampleJob struct {
	{{- if index .Includes "redis"}}
	redis *redis.Client
	{{- end}}
	{{- if index .Includes "postgres"}}
	DB *postgres.DB
	{{- end}}
	{{- if index .Includes "mysql"}}
	DB *mysql.DB
	{{- end}}
}

// NewExampleJob creates a new example job
func NewExampleJob({{- if index .Includes "redis"}}redis *redis.Client{{- end}}{{- if and (index .Includes "redis") (or (index .Includes "postgres") (index .Includes "mysql"))}}, {{- end}}{{- if index .Includes "postgres"}}db *postgres.DB{{- end}}{{- if and (index .Includes "postgres") (index .Includes "mysql")}}, {{- end}}{{- if index .Includes "mysql"}}db *mysql.DB{{- end}}) *ExampleJob {
	return &ExampleJob{
		{{- if index .Includes "redis"}}
		redis: redis,
		{{- end}}
		{{- if index .Includes "postgres"}}
		DB: db,
		{{- end}}
		{{- if index .Includes "mysql"}}
		DB: db,
		{{- end}}
	}
}

// Run executes the job (implements cron.Job interface)
func (j *ExampleJob) Run() {
	// Create context with timeout for job execution
	ctx, cancel := context.WithTimeout(context.Background(), 5*time.Minute)
	defer cancel()
	
	log.Printf("Example job starting at %v", time.Now())
	
	{{- if index .Includes "redis"}}
	// Example: Use Redis with context
	if j.redis != nil {
		client := j.redis.Client()
		if err := client.Ping(ctx).Err(); err == nil {
			log.Println("  - Redis client is available and connected")
		} else {
			log.Printf("  - Redis ping failed: %v", err)
		}
	}
	{{- end}}
	{{- if index .Includes "postgres"}}
	// Example: Use DB (Postgres) with context
	if j.DB != nil {
		db := j.DB.GORM()
		if err := db.WithContext(ctx).Exec("SELECT 1").Error; err == nil {
			log.Println("  - Postgres database is accessible")
		} else {
			log.Printf("  - Postgres query failed: %v", err)
		}
	}
	{{- end}}
	{{- if index .Includes "mysql"}}
	// Example: Use DB (MySQL) with context
	if j.DB != nil {
		db := j.DB.GORM()
		if err := db.WithContext(ctx).Exec("SELECT 1").Error; err == nil {
			log.Println("  - MySQL database is accessible")
		} else {
			log.Printf("  - MySQL query failed: %v", err)
		}
	}
	{{- end}}
	
	log.Println("Example job completed successfully")
}
