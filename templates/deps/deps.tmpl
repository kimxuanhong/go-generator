package deps

import (
	"fmt"
	"os"
	"github.com/sirupsen/logrus"

	{{- range $key, $dep := .DepsMeta }}
	{{- if index $.Includes $key }}
	{{- range $imp := $dep.Imports }}
	{{ $imp }}
	{{- end }}
	{{- end }}
	{{- end }}
)

// Deps holds all application dependencies
type Deps struct {
	Log *logrus.Logger
	{{- range $key, $dep := .DepsMeta }}
	{{- if index $.Includes $key }}
	{{- if ne $dep.StructField "" }}
	{{ $dep.StructField }}
	{{- end }}
	{{- end }}
	{{- end }}
}

// InitDeps initializes all application dependencies
func InitDeps(cfg *Config) (*Deps, error) {
	d := &Deps{}

	// Initialize logger
	if err := initLogger(d, cfg); err != nil {
		return nil, fmt.Errorf("failed to init logger: %w", err)
	}

	{{- range $key, $dep := .DepsMeta }}
	{{- if index $.Includes $key }}
	{{- range $dep.InitLines }}
	{{ . }}
	{{- end }}
	{{- end }}
	{{- end }}

	return d, nil
}

// Close closes all dependencies
func (d *Deps) Close() error {
	{{- range $key, $dep := .DepsMeta }}
	{{- if index $.Includes $key }}
	{{- range $dep.CloseLines }}
	{{ . }}
	{{- end }}
	{{- end }}
	{{- end }}
	return nil
}

// initLogger initializes the built-in logger with sensible defaults
func initLogger(d *Deps, cfg *Config) error {
	d.Log = logrus.New()
	d.Log.SetFormatter(&logrus.JSONFormatter{
		TimestampFormat: "2006-01-02T15:04:05.000Z07:00",
	})
	
	// Set log level from config or default to info
	if cfg.Log != nil && cfg.Log.Level != "" {
		level, err := logrus.ParseLevel(cfg.Log.Level)
		if err != nil {
			d.Log.SetLevel(logrus.InfoLevel)
		} else {
			d.Log.SetLevel(level)
		}
	} else {
		d.Log.SetLevel(logrus.InfoLevel)
	}
	
	d.Log.SetOutput(os.Stdout)
	return nil
}